
作者：Haichen Shen
致谢：特别感谢 Péter Garamvölgyi、Mohammad Jahanara、Ye Zhang 和 Deli Gong 对本文初稿的建议和反馈。

随着越来越多的资产从以太坊转移至 Layer 2，一个关键因素经常被忽视：安全性。正如 Vitalik 在他的演讲和博客中所指出的，像 zkEVM 如此复杂的软件需要很长时间的检验才可能完全没有漏洞。而一旦验证所有 L2 交易的单个证明器出现漏洞，带来的损失将是灾难性的。与以太坊主网的多客户端理念一样，我们在 Layer 2 上实现证明器的多样性可以显著降低单证明器带来的风险。


本文将介绍在 Scroll 中引入多证明器来增加安全性的架构。我们将探讨多证明系统领域，并解释了将 TEE（可信执行环境）证明器作为 Scroll 的辅助证明器背后的基本原理。最后，我们很高兴地与大家分享，Scroll 正在与模块化证明层 Automata 合作，我们将共同为 Scroll 开发 TEE 证明器。SGX 证明器的原型已经成功验证了所有 Scroll Sepolia 测试网的区块。

## 为什么多证明器那么重要？

ZK rollups 利用零知识证明来验证 L2 交易的正确执行。然而，ZK电路，尤其是 zkEVM 电路，是包含数万行代码的复杂软件。这种复杂性本质上增加了它们对漏洞的脆弱性。其中，完备性漏洞相对更容易监测和解决。然而，其他类似可靠性（Soundness）的漏洞不仅难以识别，而且需要大量的时间和资源来修正。

当前，ZK rollup 主要在中心化排序器和证明器上运行。在中心化的情况下，潜在漏洞下的活性和安全性主要取决于链运营商的诚实可靠程度。此外，证明器的去中心化使可靠性漏洞成为关键威胁的风险骤然增加。通过这些漏洞，证明者可以在以太坊上完成无效的状态转换，从而破坏整个区块链网络的完整性。

与客户端多样性的基本原理类似，让多种类型的证明器独立验证状态转换可显著提高系统的安全性。当这些证明器在同一批交易后一致同意状态转换时，无效交易渗透到系统中的可能性就会大大降低，从而使得 Layer2 上的用户资产变得更加安全。

## 多证明系统的设计空间？

在设计 Scroll 的多证明系统时，我们主要为了实现如下三个目标：

- 增加 Layer 2 的安全性
- 不增加最终确认时间
- 仅对 L2 交易引入边际成本

为了了解 Layer 2 证明系统的设计空间，我们使用最终确认性和安全性的关键指标来评估每个证明系统。我们从单证明系统开始。这些系统仅使用单一机制来确保 Layer 2 区块的正确性。主要分为两类：欺诈证明和 ZK 证明。Op Rollups 使用的欺诈证明依赖于验证者来质疑交易状态。它们的安全性源于验证者的经济激励，而欺诈证明的挑战期将导致最终确认的延迟。反观 ZK 证明（也称为有效性证明）利用加密协议主动生成证明，可以实现更快的最终确认时间和更稳健的安全性。

现在，让我们回到多证明系统。最近有一项提案引入了分层可争议的证明系统。但是它无法实现我们的目标。首先，它的安全性不如 ZK 证明，因为它只要求 ZK 证明验证一小部分状态转换，而大部分状态转换则由安全性较低的证明来验证。其次，由于引入争议期，最终确认时间也变慢了。

Scroll 为了实现所有三个目标，多证明系统必须使用多个证明（包括至少一个 ZK 证明）来验证所有状态转换。我们称之为“永远在线”的多重证明系统。最终确认时间、成本效益的要求缩小了我们对辅助证明器的可选择范围。在下一章节中，我们将深入探究这些选项。

## 辅助证明器有哪些选择

Scroll 上的多证明系统中的第二个证明器一共有如下三个选项。

1. 第一个最直接的选择是欺诈证明，因为它已经非常成熟并被 Op Rollups 所采用。如上所述，欺诈证明的最终确认时间有很大限制，最长可达 7 天。将欺诈证明与 ZK 证明相结合，将 L2 最终确认时间延长到最慢的证明时间，这样的最终确认性违反了我们的目标，即证明器不应增加最终确认时间。
2. 另一种选择是第二个 zkEVM 证明器。这意味着要在 Scroll 上实现另一个完全独立的 zkEVM 证明器。然而从成本和时间角度考虑，开发一个全新的 zkEVM 证明器是一项资源密集型工作。实现新的 zkEVM 证明器的复杂性和大量技术投入使得此选项只能成为长期解决方案。
3. 第三种选择是 Justin Drake 提出的可信执行环境 （TEE） 证明器。TEE 允许您在处理器的安全区域运行软件，系统中的其他组件无法访问其数据和内存。TEE 证明器在这个受保护的环境中运行，执行交易并生成证明。TEE 证明器的一个重要优势在于其效率。与验证过程相关的开销可以忽略不计，因此其解决方案比 zkEVM 证明器更快、更具成本效益。而且，TEE 证明器不会增加最终确认时间。TEE 证明器以降低活性为代价，增强了协议的安全保证。换言之，两个证明器其中之一出现漏洞不会导致用户资金被盗，但如果一旦发生，需要暂停验证桥。

在权衡了所有三个选项的利弊后，我们决定在 Scroll 中添加一个 TEE 证明器。除了上述提到的好处外，我们采用 TEE 证明器还有如下原因：

- 我们能够在 6 个月或更短的时间内将 TEE 证明器投入生产，从而增强 Scroll 主网的安全性并保障用户权益。
- 在以太坊上验证 TEE 证明的额外成本是微乎其微的，这意味着 Scroll 上交易成本的增加可以忽略不计。
- 通过引入第二个证明器来保障 Scroll 状态转换，这是 Scroll 未来实现 zkEVM 证明器去中心化的重要一步。

为了缓解社区对于信任 TEE 实现和硬件制造商的担忧，我们正在研究一种协议，来聚合多个不同硬件和客户端实现的 TEE 证明。与以太坊的分布式验证器技术 （DVT） 类似，我们可以将阈值签名方案集成到 TEE 证明生成中，例如需要 `n` 个TEE 证明器中的 `t` 个证明，从而最大限度地减少对单个硬件制造商的信任，如下图所示。

## 如何将 TEE 证明器集成到 Scroll 中？

如图所示，将 TEE 证明器集成到 Scroll 中需要确保安全、准确的状态转换验证。

- 首先，TEE 证明器必须通过提交硬件生成的有效证明报告来将自己注册到以太坊上的智能合约。证明报告还需要附上一个公钥，证明器稍后将使用该公钥对 TEE 证明进行签名，以及空间运行环境（enclave）中正在运行的软件二进制文件的哈希值，以确保 Scroll 证明程序的正确性。链上的验证器将验证报告。
- 每当新批次（batch）提交到以太坊时，注册的 TEE 证明器都会在其空间运行环境中运行，使用提交的数据执行状态转换验证程序。TEE 证明程序的输出包括旧状态根和执行交易后的新状态根，以及使用之前注册的密钥对证明的签名。
- 同时需要 ZK 和 TEE 证明才能完成 Scroll 的状态转换。双层验证系统提供了更高的安全性和可靠性，结合了 TEE 和 zkEVM 方法的优势来验证交易。
- TEE 证明器的注册会定期到期。它要求 TEE 证明器生成新的证明报告并再次注册，以防止私钥泄漏或对空间运行环境的侧信道攻击。

Scroll 链上的 TEE 证明器最初将由一个委员会管理和运营，随后将去中心化。该委员会将在其成员之间轮流负责运行 TEE 证明器。该轮换系统旨降低验证过程中出现任何单点故障或漏洞的风险。

如果 TEE 证明和 ZK 证明不一致，Scroll 链将进入“争议”状态。这种情况会触发暂停批次确认和提款过程，以保持网络的完整性。在此期间，安全委员会（将与多证明系统同时启动）介入解决冲突。安全委员会通过执行相关批次来重新计算状态根。获得安全委员会多数票的最终状态根将被接受为 Scroll 链的规范状态根。这种机制确保了证明之间的分歧可以在公开安全的环境下解决，维护了 Scroll 网络的稳定性和安全性。

## 后续进展

我们正在与 Automata 密切合作，为 Scroll 实现 SGX 证明器。SGX 证明器的原型已经构建完成，可以验证 Scroll Sepolia 测试网的所有状态转换，并且代码也已经完全开源。

未来，我们将把 SGX + ZK 的双证明系统和”争议”功能集成到 Scroll 中。我们将延续我们的安全准则，对代码进行彻底审计，以确保其符合最高的安全标准，并且我们将成立一个 TEE 证明委员会来提供必要的支持。


## 脚注

1. 在分层可争议的多证明系统设计中，系统支持从轻量级、安全性较差，便宜（例如，OP）到稳健、更安全和相对昂贵（例如 ZK）的分层证明系统。状态转换主要通过轻量级的证明来验证。然而在争议期内，轻量级的证明可能会被更有力的证明所质疑和驳斥。